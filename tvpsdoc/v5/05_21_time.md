
### Time (_Tempo_)

### Quatro Referências

Quatro referências diferentes entram em jogo ao usar valores de data e hora no Pine Script:

1. __Fuso horário UTC__: O formato nativo para valores de tempo no Pine Script é o __tempo Unix em milissegundos__. O tempo Unix é o tempo decorrido desde o __Unix Epoch em 1º de janeiro de 1970__. Veja aqui a [hora atual em Unix em segundos](https://www.unixtimestamp.com/pt) e aqui para mais informações sobre o [Tempo Unix](https://pt.wikipedia.org/wiki/Era_Unix). Um valor para o tempo Unix é chamado de _timestamp_. __Timestamps Unix__ são sempre expressos no fuso horário UTC (ou "GMT", ou "GMT+0"). Eles são medidos a partir de uma referência fixa, ou seja, o Epoch Unix, e não variam com fusos horários. Algumas funcionalidades incorporadas usam o fuso horário UTC como referência.
2. __Fuso horário da bolsa__: Uma segunda referência de tempo importante para os traders é o fuso horário da bolsa onde um instrumento é negociado. Algumas funcionalidades incorporadas, como [hour](https://br.tradingview.com/pine-script-reference/v5/#var_hour), retornam valores no fuso horário da bolsa por padrão.
3. __Parâmetro `timezone`__: Algumas funções que normalmente retornam valores no fuso horário da bolsa, como [hour()](https://br.tradingview.com/pine-script-reference/v5/#fun_hour), incluem um parâmetro `timezone` que permite adaptar o resultado da função para outro fuso horário. Outras funções, como [time()](https://br.tradingview.com/pine-script-reference/v5/#fun_time), incluem os parâmetros `session` e `timezone`. Nesses casos, o argumento `timezone` se aplica a como o argumento `session` é interpretado — não ao valor de _tempo_ retornado pela função.
4. __Fuso horário do gráfico__: Este é o fuso horário escolhido pelo usuário no gráfico usando o campo "_Configurações do Gráfico/Símbolo/Fuso Horário_" "_Chart Settings/Symbol/Time Zone_". Esta configuração afeta apenas a exibição de datas e horários no gráfico. Não afeta o comportamento dos scripts Pine, e eles não têm visibilidade sobre essa configuração.

Ao discutir variáveis ou funções, será notado se elas retornam datas ou horários em UTC ou no fuso horário da bolsa. Scripts não têm visibilidade sobre a configuração de fuso horário do usuário no gráfico.

### Funções e Variáveis Incorporadas de Tempo

Pine Script possui _variáveis_ "__incorporadas__" "__built-in__" para:

- Obter informações de timestamp da barra atual (fuso horário UTC): [time](https://br.tradingview.com/pine-script-reference/v5/#var_time) e [time_close](https://br.tradingview.com/pine-script-reference/v5/#var_time_close)
- Obter informações de timestamp para o início do dia de negociação atual (fuso horário UTC): [time_tradingday](https://br.tradingview.com/pine-script-reference/v5/#var_time_tradingday)
- Obter o horário atual em incrementos de um segundo (fuso horário UTC): [timenow](https://br.tradingview.com/pine-script-reference/v5/#var_timenow)
- Recuperar valores de calendário e tempo da barra (fuso horário da bolsa): [year](https://br.tradingview.com/pine-script-reference/v5/#var_year), [month](https://br.tradingview.com/pine-script-reference/v5/#var_month), [weekofyear](https://br.tradingview.com/pine-script-reference/v5/#var_weekofyear), [dayofmonth](https://br.tradingview.com/pine-script-reference/v5/#var_dayofmonth), [dayofweek](https://br.tradingview.com/pine-script-reference/v5/#var_dayofweek), [hour](https://br.tradingview.com/pine-script-reference/v5/#var_hour), [minute](https://br.tradingview.com/pine-script-reference/v5/#var_minute) e [second](https://br.tradingview.com/pine-script-reference/v5/#var_second)
- Retornar o fuso horário da bolsa do símbolo do gráfico com [syminfo.timezone](https://br.tradingview.com/pine-script-reference/v5/#var_syminfo%7Bdot%7Dtimezone)

Também há _funções_ __incorporadas__ que podem:

- Retornar timestamps de barras de outros períodos com [time()](https://br.tradingview.com/pine-script-reference/v5/#fun_time) e [time_close()](https://br.tradingview.com/pine-script-reference/v5/#fun_time_close), sem a necessidade de uma chamada [request.security()](https://br.tradingview.com/pine-script-reference/v5/#fun_request%7Bdot%7Dsecurity)
- Recuperar valores de calendário e tempo de qualquer timestamp, que podem ser ajustados com um fuso horário: [year()](https://br.tradingview.com/pine-script-reference/v5/#fun_year), [month()](https://br.tradingview.com/pine-script-reference/v5/#fun_month), [weekofyear()](https://br.tradingview.com/pine-script-reference/v5/#fun_weekofyear), [dayofmonth()](https://br.tradingview.com/pine-script-reference/v5/#fun_dayofmonth), [dayofweek()](https://br.tradingview.com/pine-script-reference/v5/#fun_dayofweek), [hour()](https://br.tradingview.com/pine-script-reference/v5/#fun_hour), [minute()](https://br.tradingview.com/pine-script-reference/v5/#fun_minute) e [second()](https://br.tradingview.com/pine-script-reference/v5/#fun_second)
- Criar um timestamp usando [timestamp()](https://br.tradingview.com/pine-script-reference/v5/#fun_timestamp)
- Converter um timestamp para uma string de data/hora formatada para exibição, usando [str.format()](https://br.tradingview.com/pine-script-reference/v5/#fun_str%7Bdot%7Dformat)
- Inserir valores de data e hora. Veja a seção sobre [Entradas](./05_09_inputs.md).
- Trabalhar com [informações de sessão](./05_17_sessoes.md).

<!-- ### Fusos Horários

Os usuários do TradingView podem alterar o fuso horário usado para exibir os horários das barras em seus gráficos. Scripts Pine não têm visibilidade sobre essa configuração. Embora haja uma variável [syminfo.timezone](https://br.tradingview.com/pine-script-reference/v5/#var_syminfo%7Bdot%7Dtimezone) para retornar o fuso horário da bolsa onde o instrumento do gráfico é negociado, __não__ existe um equivalente `chart.timezone`.

Ao exibir horários no gráfico, esta é uma maneira de fornecer aos usuários um meio de ajustar os valores de tempo do seu script aos do gráfico deles. Dessa forma, os horários exibidos podem corresponder ao fuso horário usado pelos traders em seu gráfico:

![Exemplo de controle de fuso horário](./imgs/Time-TimeZones-01.BhZfcsQ2_BWgd3.webp)

```pinescript
//@version=5
indicator("Time zone control")
MS_IN_1H = 1000 * 60 * 60
TOOLTIP01 = "Enter your time zone's offset (+ or −), including a decimal fraction if needed."
hoursOffsetInput = input.float(0.0, "Timezone offset (in hours)", minval = -12.0, maxval = 14.0, step = 0.5, tooltip = TOOLTIP01)

printTable(txt) =>  
    var table t = table.new(position.middle_right, 1, 1)  
    table.cell(t, 0, 0, txt, text_halign = text.align_right, bgcolor = color.yellow)  

msOffsetInput = hoursOffsetInput * MS_IN_1H
printTable(
    str.format("Last bar''s open time UTC: {0,date,HH:mm:ss yyyy.MM.dd}", time) +  
    str.format("\nLast bar''s close time UTC: {0,date,HH:mm:ss yyyy.MM.dd}", time_close) +  
    str.format("\n\nLast bar''s open time EXCHANGE: {0,date,HH:mm:ss yyyy.MM.dd}", time(timeframe.period, syminfo.session, syminfo.timezone)) +  
    str.format("\nLast bar''s close time EXCHANGE: {0,date,HH:mm:ss yyyy.MM.dd}", time_close(timeframe.period, syminfo.session, syminfo.timezone)) +  
    str.format("\n\nLast bar''s open time OFFSET ({0}): {1,date,HH:mm:ss yyyy.MM.dd}", hoursOffsetInput, time + msOffsetInput) +  
    str.format("\nLast bar''s close time OFFSET ({0}): {1,date,HH:mm:ss yyyy.MM.dd}", hoursOffsetInput, time_close + msOffsetInput) +  
    str.format("\n\nCurrent time OFFSET ({0}): {1,date,HH:mm:ss yyyy.MM.dd}", hoursOffsetInput, timenow + msOffsetInput)
)
```

__Note que:__

- Converte-se o deslocamento do usuário expresso em horas para milissegundos com `msOffsetInput`. Em seguida, adiciona-se esse deslocamento a um timestamp em formato UTC antes de convertê-lo para o formato de exibição, por exemplo, `time + msOffsetInput` e `timenow + msOffsetInput`.
-

 Utiliza-se um tooltip para fornecer instruções aos usuários.
- Fornecem-se valores `minval` e `maxval` para proteger o campo de entrada e um valor `step` de 0,5 para que, quando utilizarem as setas para cima/baixo do campo, possam entender intuitivamente que frações podem ser usadas.
- A função [str.format()](https://br.tradingview.com/pine-script-reference/v5/#fun_str%7Bdot%7Dformat) formata os valores de tempo, nomeadamente o horário da última barra e o horário atual.

Algumas funções que normalmente retornam valores no fuso horário da bolsa fornecem meios para adaptar o resultado a outro fuso horário por meio do parâmetro `timezone`. Este script ilustra como fazer isso com [hour()](https://br.tradingview.com/pine-script-reference/v5/#fun_hour):

![Exemplo de uso de timezone](./imgs/Time-TimeZones-02.xptlcK0i_1VVd7u.webp)

```pinescript
//@version=5
indicator('hour(time, "GMT+0") in orange')
color BLUE_LIGHT = #0000FF30
plot(hour, "", BLUE_LIGHT, 8)
plot(hour(time, syminfo.timezone))
plot(hour(time, "GMT+0"),"UTC", color.orange)
```

__Note que:__

- A variável [hour](https://br.tradingview.com/pine-script-reference/v5/#var_hour) e a função [hour()](https://br.tradingview.com/pine-script-reference/v5/#fun_hour) normalmente retornam um valor no fuso horário da bolsa. Assim, os plots em azul para `hour` e `hour(time, syminfo.timezone)` se sobrepõem. Usar a forma de função com `syminfo.timezone` é redundante se a hora da bolsa for necessária.
- A linha laranja plotando `hour(time, "GMT+0")`, no entanto, retorna a hora da barra em UTC, ou horário "GMT+0", que neste caso é quatro horas a menos que a hora da bolsa, já que a MSFT é negociada na NASDAQ, cujo fuso horário é UTC-4.

#### Strings de Fuso Horário

O argumento usado para o parâmetro `timezone` em funções como [time()](https://br.tradingview.com/pine-script-reference/v5/#fun_time), [timestamp()](https://br.tradingview.com/pine-script-reference/v5/#fun_timestamp), [hour()](https://br.tradingview.com/pine-script-reference/v5/#fun_hour), etc., pode estar em diferentes formatos, que podem ser encontrados na página de referência [IANA time zone database name](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones). Os conteúdos das colunas "TZ database name", "UTC offset ±hh:mm" e "UTC DST offset ±hh:mm" da tabela dessa página podem ser usados.

Para expressar um deslocamento de +5,5 horas a partir do UTC, essas strings encontradas na página de referência são todas equivalentes:

- `"GMT+05:30"`
- `"Asia/Calcutta"`
- `"Asia/Colombo"`
- `"Asia/Kolkata"`

Deslocamentos não fracionários podem ser expressos na forma `"GMT+5"`. `"GMT+5.5"` não é permitido.

## Variáveis de Tempo

### `time` e `time_close`

Vamos começar plotando [time](https://br.tradingview.com/pine-script-reference/v5/#var_time) e [time_close](https://br.tradingview.com/pine-script-reference/v5/#var_time_close), o timestamp Unix em milissegundos do horário de abertura e fechamento da barra:

![Valores de time e time_close nas barras](./imgs/Time-TimeAndTimeclose-01.Db16O5Ht_ZGCjBm.webp)

```pinescript
//@version=5
indicator("time and time_close values on bars")
plot(time, "time")
plot(time_close, "time_close")
```

__Note que:__

- As variáveis [time](https://br.tradingview.com/pine-script-reference/v5/#var_time) e [time_close](https://br.tradingview.com/pine-script-reference/v5/#var_time_close) retornam um timestamp em [UNIX time](https://en.wikipedia.org/wiki/Unix_time), que é independente do fuso horário selecionado pelo usuário no gráfico. Neste caso, a configuração de fuso horário do __gráfico__ é o fuso horário da bolsa, então, qualquer que seja o símbolo no gráfico, o fuso horário da bolsa será usado para exibir os valores de data e hora no cursor do gráfico. O fuso horário da NASDAQ é UTC-4, mas isso afeta apenas a exibição de valores de data/hora no gráfico; não impacta os valores plotados pelo script.
- O último valor de [time](https://br.tradingview.com/pine-script-reference/v5/#var_time) para o plot mostrado na escala é o número de milissegundos decorridos desde 00:00:00 UTC de 1º de janeiro de 1970 até o horário de abertura da barra. Corresponde às 17:30 do dia 27 de setembro de 2021. No entanto, como o gráfico usa o fuso horário UTC-4 (o fuso horário da NASDAQ), exibe o horário 13:30, quatro horas antes do horário UTC.
- A diferença entre os dois valores na última barra é o número de milissegundos em uma hora (1000 * 60 * 60 = 3.600.000) porque estamos em um gráfico de 1H. -->
